uuid: 481cdfcd-3c80-43ed-af99-52ba9a711714
langcode: en
status: true
dependencies:
  config:
    - field.field.node.certificate.field_employee
    - field.field.node.certificate.field_limit_
    - field.field.node.transaction.field_actual_balance
    - field.field.node.transaction.field_certificate
    - field.field.node.transaction.field_days
    - field.field.node.transaction.field_owner
    - field.field.node.transaction.field_previous_balance
    - field.field.node.transaction.field_status_transactions
    - field.field.user.user.field_balance_a_vacations_day
    - field.field.user.user.field_balance_current_day
    - field.storage.node.field_actual_balance
    - field.storage.node.field_certificate
    - field.storage.node.field_days
    - field.storage.node.field_employee
    - field.storage.node.field_limit_
    - field.storage.node.field_owner
    - field.storage.node.field_previous_balance
    - field.storage.node.field_status_transactions
    - field.storage.user.field_balance_a_vacations_day
    - field.storage.user.field_balance_current_day
    - node.type.certificate
    - node.type.transaction
    - views.view.current_certificate
  module:
    - eca_base
    - eca_content
    - eca_tamper
    - eca_user
    - eca_views
id: process_syiklwv
modeller: bpmn_io
label: 'Burn days'
version: ''
weight: null
events:
  Event_0ggzb2v:
    plugin: 'content_entity:update'
    label: 'upd certificate'
    configuration:
      type: 'node certificate'
    successors:
      -
        id: Activity_03tnv4l
        condition: Flow_09cd42h
  Event_0kfl1fu:
    plugin: 'content_entity:custom'
    label: x2
    configuration:
      event_id: x2
    successors:
      -
        id: Activity_1s0e3nt
        condition: ''
conditions:
  Flow_199mib5:
    plugin: eca_scalar
    configuration:
      negate: false
      case: false
      left: '[result_number]'
      right: '[entity:field_limit_:value]'
      operator: lessthan
      type: value
  Flow_0w1x6ji:
    plugin: eca_scalar
    configuration:
      negate: false
      case: false
      left: '[result_number]'
      right: '[entity:field_limit_:value]'
      operator: greaterthan
      type: value
  Flow_09cd42h:
    plugin: eca_scalar
    configuration:
      negate: false
      case: false
      left: '[entity:field_current_state_certificate:value]'
      right: state_certificate_disabled
      operator: equal
      type: value
  Flow_1m5nwwq:
    plugin: eca_count
    configuration:
      negate: false
      case: false
      left: my_certificates
      right: '0'
      operator: greaterthan
      type: numeric
  Flow_1qimo2p:
    plugin: eca_count
    configuration:
      negate: false
      case: false
      left: my_certificates
      right: '0'
      operator: equal
      type: numeric
  Flow_1wsb6de:
    plugin: eca_scalar
    configuration:
      negate: false
      case: false
      left: '[result_number]'
      right: '[entity:field_limit_:value]'
      operator: equal
      type: value
  Flow_1c3a4me:
    plugin: eca_scalar
    configuration:
      negate: false
      case: false
      left: '[result_number]'
      right: '0'
      operator: equal
      type: value
gateways:
  Gateway_191dxix:
    type: 0
    successors:
      -
        id: Activity_1vsz3y0
        condition: Flow_199mib5
      -
        id: Activity_1fj42hl
        condition: Flow_0w1x6ji
      -
        id: Activity_1fj42hl
        condition: Flow_1wsb6de
      -
        id: Activity_1iceyv2
        condition: Flow_1c3a4me
  Gateway_0mdlk00:
    type: 0
    successors:
      -
        id: Activity_1lmzhyu
        condition: Flow_1m5nwwq
      -
        id: Activity_059edt5
        condition: Flow_1qimo2p
actions:
  Activity_0m9f0ff:
    plugin: eca_get_field_value
    label: 'get actual balance'
    configuration:
      field_name: field_balance_a_vacations_day
      token_name: actual_balance
      object: '[employee_certificate]'
    successors:
      -
        id: Activity_0bxblux
        condition: ''
      -
        id: Activity_1uc4cke
        condition: ''
  Activity_1vsz3y0:
    plugin: eca_switch_account
    label: 'Switch to admin'
    configuration:
      user_id: '1'
    successors:
      -
        id: Activity_1tm35pc
        condition: ''
      -
        id: Activity_0b87gf5
        condition: ''
  Activity_1fj42hl:
    plugin: eca_switch_account
    label: 'switch to admin'
    configuration:
      user_id: '1'
    successors:
      -
        id: Activity_1dudhxf
        condition: ''
  Activity_0bxblux:
    plugin: 'eca_tamper:math'
    label: 'input [result_number]'
    configuration:
      operation: subtraction
      flip: false
      value: '[actual_balance]'
      eca_data: '[max_day]'
      eca_token_name: result_number
    successors:
      -
        id: Gateway_191dxix
        condition: ''
      -
        id: Activity_1t03wtt
        condition: ''
  Activity_1tm35pc:
    plugin: eca_new_entity
    label: 'create new'
    configuration:
      token_name: burn_transaction
      type: 'node transaction'
      langcode: ''
      label: 'Burn transaction to [first_certificate:title]'
      published: true
      owner: '1'
    successors:
      -
        id: Activity_1ieitrk
        condition: ''
      -
        id: Activity_0pyfpxu
        condition: ''
  Activity_1ieitrk:
    plugin: eca_set_field_value
    label: 'set field owner'
    configuration:
      field_name: field_owner
      field_value: '[employee_certificate]'
      method: 'set:clear'
      strip_tags: false
      trim: false
      save_entity: false
      object: '[burn_transaction]'
    successors:
      -
        id: Activity_1ggicai
        condition: ''
  Activity_1ggicai:
    plugin: eca_set_field_value
    label: 'set field TYPE'
    configuration:
      field_name: field_status_transactions
      field_value: transaction_type_spent_when_burning_day
      method: 'set:clear'
      strip_tags: false
      trim: false
      save_entity: false
      object: '[burn_transaction]'
    successors:
      -
        id: Activity_15w6fi2
        condition: ''
  Activity_15w6fi2:
    plugin: eca_set_field_value
    label: 'set field CERTIFICATE'
    configuration:
      field_name: field_certificate
      field_value: '[first_certificate]'
      method: 'set:clear'
      strip_tags: false
      trim: false
      save_entity: false
      object: '[burn_transaction]'
    successors:
      -
        id: Activity_0p03q33
        condition: ''
  Activity_1ajidky:
    plugin: eca_set_field_value
    label: 'set field DAYS'
    configuration:
      field_name: field_days
      field_value: '[number_days]'
      method: 'set:clear'
      strip_tags: false
      trim: false
      save_entity: false
      object: '[burn_transaction]'
    successors:
      -
        id: Activity_0ct4jp5
        condition: ''
      -
        id: Activity_179yxps
        condition: ''
  Activity_0p03q33:
    plugin: 'eca_tamper:math'
    label: math
    configuration:
      operation: subtraction
      flip: false
      value: '[result_number]'
      eca_data: '[entity:field_limit_:value]'
      eca_token_name: '[number_days]'
    successors:
      -
        id: Activity_1ajidky
        condition: ''
  Activity_1dudhxf:
    plugin: eca_new_entity
    label: 'create new'
    configuration:
      token_name: burn_transaction_null_day
      type: 'node transaction'
      langcode: ''
      label: 'Null burn days in certificate "[first_certificate:title]"'
      published: true
      owner: '1'
    successors:
      -
        id: Activity_1ednkno
        condition: ''
  Activity_1ednkno:
    plugin: eca_set_field_value
    label: 'set field owner'
    configuration:
      field_name: field_owner
      field_value: '[employee_certificate]'
      method: 'set:clear'
      strip_tags: false
      trim: false
      save_entity: false
      object: '[burn_transaction_null_day]'
    successors:
      -
        id: Activity_15znkei
        condition: ''
  Activity_15znkei:
    plugin: eca_set_field_value
    label: 'set field TYPE'
    configuration:
      field_name: field_status_transactions
      field_value: transaction_type_spent_when_burning_day
      method: 'set:clear'
      strip_tags: false
      trim: false
      save_entity: false
      object: '[burn_transaction_null_day]'
    successors:
      -
        id: Activity_0inokg6
        condition: ''
  Activity_0inokg6:
    plugin: eca_set_field_value
    label: 'set field CERTIFICATE'
    configuration:
      field_name: field_certificate
      field_value: '[first_certificate]'
      method: 'set:clear'
      strip_tags: false
      trim: false
      save_entity: false
      object: '[burn_transaction_null_day]'
    successors:
      -
        id: Activity_0vr0xq3
        condition: ''
  Activity_0vr0xq3:
    plugin: eca_set_field_value
    label: 'set field DAYs'
    configuration:
      field_name: field_days
      field_value: '0'
      method: 'set:clear'
      strip_tags: false
      trim: false
      save_entity: false
      object: '[burn_transaction_null_day]'
    successors:
      -
        id: Activity_09bi9p7
        condition: ''
  Activity_09bi9p7:
    plugin: eca_save_entity
    label: save
    configuration:
      object: '[burn_transaction_null_day]'
    successors:
      -
        id: Activity_0x3fjeh
        condition: ''
  Activity_1iteihk:
    plugin: action_message_action
    label: '#9'
    configuration:
      replace_tokens: false
      message: '#9 Зберегли транзакцію по згорянню днів і запустили тригер по відніманню днів з поточного балансу юзера'
    successors: {  }
  Activity_03tnv4l:
    plugin: eca_token_load_entity
    label: 'load to employee in certificate'
    configuration:
      token_name: employee_certificate
      from: id
      entity_type: user
      entity_id: '[entity:field_employee:entity:uid]'
      revision_id: ''
      properties: ''
      langcode: _interface
      latest_revision: false
      unchanged: false
      object: ''
    successors:
      -
        id: Activity_16l40qv
        condition: ''
      -
        id: Activity_1wx8spx
        condition: ''
  Activity_16l40qv:
    plugin: eca_switch_account
    label: 'switch to this user'
    configuration:
      user_id: '[employee_certificate]'
    successors:
      -
        id: Activity_1df6qz1
        condition: ''
  Activity_17hbw82:
    plugin: eca_set_field_value
    label: 'set field balance user'
    configuration:
      field_name: field_balance_a_vacations_day
      field_value: '[day_not_used]'
      method: 'set:clear'
      strip_tags: false
      trim: false
      save_entity: true
      object: '[owner_transactions]'
    successors:
      -
        id: Activity_0gfgfxg
        condition: ''
  Activity_1bbly09:
    plugin: 'eca_tamper:math'
    label: Activity_1bbly09
    configuration:
      operation: subtraction
      flip: false
      value: '[entity:field_days:value]'
      eca_data: '[balance]'
      eca_token_name: day_not_used
    successors:
      -
        id: Activity_17hbw82
        condition: ''
  Activity_0gfgfxg:
    plugin: action_message_action
    label: Activity_0gfgfxg
    configuration:
      replace_tokens: false
      message: 'upd balance useer to [day_not_used]'
    successors:
      -
        id: Activity_0j4ya8b
        condition: ''
  Activity_14ix130:
    plugin: eca_views_query
    label: 'view "My current certificate"'
    configuration:
      token_name: my_certificates
      view_id: current_certificate
      display_id: block_1
      arguments: '[employee_certificate]'
    successors:
      -
        id: Activity_0n050zi
        condition: ''
  Activity_0n050zi:
    plugin: eca_count
    label: 'count certificate'
    configuration:
      token_name: count_certificates
      list_token: my_certificates
    successors:
      -
        id: Gateway_0mdlk00
        condition: ''
  Activity_1lmzhyu:
    plugin: eca_list_remove
    label: 'remove item'
    configuration:
      value: ''
      token_name: first_certificate
      method: first
      index: ''
      list_token: my_certificates
    successors:
      -
        id: Activity_1e39onf
        condition: ''
  Activity_1e39onf:
    plugin: 'eca_tamper:math'
    label: 'get max_days'
    configuration:
      operation: addition
      flip: false
      value: '[max_day]'
      eca_data: '[first_certificate:field_limit_:value]'
      eca_token_name: max_day
    successors:
      -
        id: Activity_0iq76vf
        condition: ''
      -
        id: Gateway_0mdlk00
        condition: ''
  Activity_1t03wtt:
    plugin: action_message_action
    label: '#4'
    configuration:
      replace_tokens: false
      message: '#4 Отримали кількість днів,які було витрачено за рік [result_number]'
    successors: {  }
  Activity_1df6qz1:
    plugin: eca_get_field_value
    label: 'get balance'
    configuration:
      field_name: field_balance_current_day
      token_name: max_day
      object: '[employee_certificate]'
    successors:
      -
        id: Activity_14ix130
        condition: ''
  Activity_1uc4cke:
    plugin: action_message_action
    label: '#3'
    configuration:
      replace_tokens: false
      message: '#3 Отримали актуальний баланс юзера [actual_balance]'
    successors: {  }
  Activity_0b87gf5:
    plugin: action_message_action
    label: '#5'
    configuration:
      replace_tokens: false
      message: '#5 Якщо [result_number] < [entity:field_limit_:value]'
    successors: {  }
  Activity_0ct4jp5:
    plugin: action_message_action
    label: '#7'
    configuration:
      replace_tokens: false
      message: '#7 Отримуємо кількість днів,які не були використані з сертифіката, що згорів [number_days]'
    successors: {  }
  Activity_0zulopl:
    plugin: eca_trigger_content_entity_custom_event
    label: 'TRIGGER x2'
    configuration:
      event_id: x2
      tokens: ''
      object: '[burn_transaction]'
    successors: {  }
  Activity_0o3klzu:
    plugin: eca_token_load_entity_ref
    label: 'load owner in transaction'
    configuration:
      field_name_entity_ref: field_owner
      token_name: owner_transactions
      from: current
      entity_type: user
      entity_id: ''
      revision_id: ''
      properties: ''
      langcode: _interface
      latest_revision: false
      unchanged: false
      object: '[burn_transaction]'
    successors:
      -
        id: Activity_0ujekzk
        condition: ''
  Activity_0ujekzk:
    plugin: eca_get_field_value
    label: 'get balance'
    configuration:
      field_name: field_balance_a_vacations_day
      token_name: balance
      object: '[owner_transactions]'
    successors:
      -
        id: Activity_1bbly09
        condition: ''
      -
        id: Activity_0fme9yb
        condition: ''
  Activity_0fme9yb:
    plugin: action_message_action
    label: '#10'
    configuration:
      replace_tokens: false
      message: '#10 Отримали поточний баланс юзера [balance], він має збігатись з балансом з повідомлення #6'
    successors: {  }
  Activity_1s0e3nt:
    plugin: eca_switch_account
    label: 'switch to user'
    configuration:
      user_id: '1'
    successors:
      -
        id: Activity_0o3klzu
        condition: ''
  Activity_0j4ya8b:
    plugin: action_message_action
    label: '#11'
    configuration:
      replace_tokens: false
      message: '#11 Заповнили значення поля юзера новим актуальним балансом [balance]'
    successors: {  }
  Activity_0iq76vf:
    plugin: action_message_action
    label: '#2'
    configuration:
      replace_tokens: false
      message: '#2 отримали суму всіх поточних сертифікатів [max_day]'
    successors: {  }
  Activity_059edt5:
    plugin: eca_count
    label: Activity_059edt5
    configuration:
      token_name: current_count
      list_token: my_certificates
    successors:
      -
        id: Activity_0m9f0ff
        condition: ''
  Activity_0x3fjeh:
    plugin: action_message_action
    label: Activity_0x3fjeh
    configuration:
      replace_tokens: false
      message: 'Ура, створено нову транзакцію на згоряння з нуль днів'
    successors: {  }
  Activity_179yxps:
    plugin: eca_set_field_value
    label: 'set field PREVIOUS BALANCE'
    configuration:
      field_name: field_previous_balance
      field_value: '[employee_certificate:field_balance_a_vacations_day:value]'
      method: 'set:clear'
      strip_tags: false
      trim: false
      save_entity: false
      object: '[burn_transaction]'
    successors:
      -
        id: Activity_04z6wod
        condition: ''
  Activity_04z6wod:
    plugin: 'eca_tamper:math'
    label: 'MATH actual-balance - day_not_used'
    configuration:
      operation: subtraction
      flip: false
      value: '[number_days]'
      eca_data: '[employee_certificate:field_balance_a_vacations_day:value]'
      eca_token_name: transaction_actual_balance
    successors:
      -
        id: Activity_0355lf6
        condition: ''
      -
        id: Activity_08nqpnu
        condition: ''
  Activity_0355lf6:
    plugin: eca_set_field_value
    label: 'set field ACTUAL BALANCE'
    configuration:
      field_name: field_actual_balance
      field_value: '[transaction_actual_balance]'
      method: 'set:clear'
      strip_tags: false
      trim: false
      save_entity: false
      object: '[burn_transaction]'
    successors:
      -
        id: Activity_044krtd
        condition: ''
  Activity_044krtd:
    plugin: eca_save_entity
    label: SAVE
    configuration:
      object: '[burn_transaction]'
    successors:
      -
        id: Activity_1iteihk
        condition: ''
      -
        id: Activity_0zulopl
        condition: ''
  Activity_1wx8spx:
    plugin: action_message_action
    label: '#1'
    configuration:
      replace_tokens: false
      message: '#1 Сертифікат згорів'
    successors: {  }
  Activity_0pyfpxu:
    plugin: action_message_action
    label: '#6'
    configuration:
      replace_tokens: false
      message: '#6 То створюємо транзакцію по згорянню днів, значення актуального балансу юзера = [employee_certificate:field_balance_a_vacations_day:value]'
    successors: {  }
  Activity_08nqpnu:
    plugin: action_message_action
    label: '#8'
    configuration:
      replace_tokens: false
      message: '#8 Щоб отримати актуальний баланс для транзакції, потрібно отримати різницю [employee_certificate:field_balance_a_vacations_day:value] - [number_days]'
    successors: {  }
  Activity_1iceyv2:
    plugin: eca_switch_account
    label: 'switch to admin'
    configuration:
      user_id: '1'
    successors:
      -
        id: Activity_07khjo5
        condition: ''
  Activity_07khjo5:
    plugin: eca_new_entity
    label: 'Create new'
    configuration:
      token_name: burn_all_day
      type: 'node transaction'
      langcode: ''
      label: 'Burning out all days from the [first_certificate:title]'
      published: true
      owner: '1'
    successors:
      -
        id: Activity_0zm2guw
        condition: ''
      -
        id: Activity_15f30ms
        condition: ''
  Activity_0zm2guw:
    plugin: eca_set_field_value
    label: 'set field owner'
    configuration:
      field_name: field_owner
      field_value: '[employee_certificate]'
      method: 'set:clear'
      strip_tags: false
      trim: false
      save_entity: false
      object: '[burn_all_day]'
    successors:
      -
        id: Activity_0o9m2i6
        condition: ''
  Activity_0o9m2i6:
    plugin: eca_set_field_value
    label: 'set field Type transaction'
    configuration:
      field_name: field_status_transactions
      field_value: transaction_type_spent_when_burning_day
      method: 'set:clear'
      strip_tags: false
      trim: false
      save_entity: false
      object: v
    successors:
      -
        id: Activity_1wvbu7o
        condition: ''
  Activity_1wvbu7o:
    plugin: eca_set_field_value
    label: 'set field certificate'
    configuration:
      field_name: field_certificate
      field_value: '[first_certificate]'
      method: 'set:clear'
      strip_tags: false
      trim: false
      save_entity: false
      object: '[burn_all_day]'
    successors:
      -
        id: Activity_0qbzxao
        condition: ''
  Activity_0qbzxao:
    plugin: eca_set_field_value
    label: 'set field Days'
    configuration:
      field_name: field_days
      field_value: '[entity:field_limit_:value]'
      method: 'set:clear'
      strip_tags: false
      trim: false
      save_entity: false
      object: '[burn_all_day]'
    successors:
      -
        id: Activity_154c1rt
        condition: ''
      -
        id: Activity_0tjmuoo
        condition: ''
  Activity_154c1rt:
    plugin: eca_set_field_value
    label: 'set field previous balance'
    configuration:
      field_name: field_previous_balance
      field_value: '[employee_certificate:field_balance_a_vacations_day:value]'
      method: 'set:clear'
      strip_tags: false
      trim: false
      save_entity: false
      object: '[burn_all_day]'
    successors:
      -
        id: Activity_12u9sfn
        condition: ''
  Activity_12u9sfn:
    plugin: 'eca_tamper:math'
    label: math
    configuration:
      operation: subtraction
      flip: false
      value: '[entity:field_limit_:value]'
      eca_data: '[employee_certificate:field_balance_a_vacations_day:value]'
      eca_token_name: actual_balance_burn_all_day
    successors:
      -
        id: Activity_1lfjbwk
        condition: ''
  Activity_1lfjbwk:
    plugin: eca_set_field_value
    label: 'set field Actual balance'
    configuration:
      field_name: field_actual_balance
      field_value: '[actual_balance_burn_all_day]'
      method: 'set:clear'
      strip_tags: false
      trim: false
      save_entity: false
      object: '[burn_all_day]'
    successors:
      -
        id: Activity_0enqoj9
        condition: ''
  Activity_0enqoj9:
    plugin: eca_save_entity
    label: save
    configuration:
      object: '[burn_all_day]'
    successors:
      -
        id: Activity_0zulopl
        condition: ''
  Activity_15f30ms:
    plugin: action_message_action
    label: '#10'
    configuration:
      replace_tokens: false
      message: '#10 Створено транзакцію на списання всіх днів ,тому що [result_number] = 0'
    successors: {  }
  Activity_0tjmuoo:
    plugin: action_message_action
    label: Activity_0tjmuoo
    configuration:
      replace_tokens: false
      message: '#11  Заповнила філд field_days значенням [entity:field_limit_:value]'
    successors: {  }
