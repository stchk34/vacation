uuid: 9154adde-c0d5-44d0-b6cb-4a5272ef672f
langcode: en
status: true
dependencies:
  config:
    - field.field.node.certificate.field_employee
    - field.field.node.certificate.field_limit_
    - field.field.node.transaction.field_certificate
    - field.field.node.transaction.field_owner
    - field.field.node.transaction.field_status_transactions
    - field.field.user.user.field_balance_a_vacations_day
    - field.storage.node.field_certificate
    - field.storage.node.field_employee
    - field.storage.node.field_limit_
    - field.storage.node.field_owner
    - field.storage.node.field_status_transactions
    - field.storage.user.field_balance_a_vacations_day
    - node.type.certificate
    - node.type.transaction
    - views.view.list_current_certificate
  module:
    - eca_base
    - eca_content
    - eca_tamper
    - eca_user
    - eca_views
id: process_mnpyrtg
modeller: bpmn_io
label: 'Create earned transaction after publish certificate'
version: ''
weight: -10
events:
  Event_0nxdeo6:
    plugin: 'content_entity:update'
    label: 'UPD certificate'
    configuration:
      type: 'node certificate'
    successors:
      -
        id: Activity_1v0snzp
        condition: ''
  Event_0z1i0aa:
    plugin: 'content_entity:custom'
    label: Event_0z1i0aa
    configuration:
      event_id: x2
    successors:
      -
        id: Activity_0qxx88b
        condition: ''
conditions:
  Flow_0r39t83:
    plugin: eca_count
    configuration:
      negate: false
      case: false
      left: '0'
      right: ''
      operator: equal
      type: numeric
  Flow_0m313sr:
    plugin: eca_scalar
    configuration:
      negate: false
      case: false
      left: '[number_used_days_per_year]'
      right: '[burned_certificate:field_limit_:value]'
      operator: greaterthan
      type: value
  Flow_0nmpiry:
    plugin: eca_scalar
    configuration:
      negate: false
      case: false
      left: '[number_used_days_per_year]'
      right: '[burned_certificate:field_limit_:value]'
      operator: lessthan
      type: value
  Flow_0t4mg1p:
    plugin: eca_entity_field_value
    configuration:
      negate: false
      case: false
      expected_value: '1'
      field_name: status.value
      operator: equal
      type: value
      entity: '[certificate]'
gateways:
  Gateway_1vuijuo:
    type: 0
    successors:
      -
        id: Activity_0uyxgwr
        condition: Flow_0r39t83
  Gateway_0g6vu09:
    type: 0
    successors:
      -
        id: Activity_0eo0i23
        condition: Flow_0m313sr
      -
        id: Activity_1718kix
        condition: Flow_0nmpiry
actions:
  Activity_0qxx88b:
    plugin: eca_token_load_entity
    label: 'load transaction'
    configuration:
      token_name: burning_days_transaction
      from: current
      entity_type: _none
      entity_id: ''
      revision_id: ''
      properties: ''
      langcode: _interface
      latest_revision: false
      unchanged: false
      object: ''
    successors:
      -
        id: Activity_1ajejn4
        condition: ''
  Activity_1ajejn4:
    plugin: eca_token_load_entity
    label: 'load owner'
    configuration:
      token_name: owner
      from: id
      entity_type: user
      entity_id: '[burning_days_transaction:field_owner:entity:uid]'
      revision_id: ''
      properties: ''
      langcode: _interface
      latest_revision: false
      unchanged: false
      object: '[burning_days_transaction]'
    successors:
      -
        id: Activity_0nwhz05
        condition: ''
  Activity_0nwhz05:
    plugin: eca_switch_account
    label: 'switch to owner'
    configuration:
      user_id: '[burning_days_transaction:field_owner:entity:uid]'
    successors:
      -
        id: Activity_1125ixz
        condition: ''
  Activity_1125ixz:
    plugin: eca_views_query
    label: 'Views "Current Certificate"'
    configuration:
      token_name: current_certificates
      view_id: list_current_certificate
      display_id: page_1
      arguments: ''
    successors:
      -
        id: Gateway_1vuijuo
        condition: ''
  Activity_0uyxgwr:
    plugin: eca_token_load_entity
    label: 'load burned certificate'
    configuration:
      token_name: burned_certificate
      from: id
      entity_type: node
      entity_id: '[current_certificates:0:nid]'
      revision_id: ''
      properties: ''
      langcode: _interface
      latest_revision: false
      unchanged: false
      object: ''
    successors:
      -
        id: Activity_02m3tlp
        condition: ''
  Activity_02m3tlp:
    plugin: eca_token_load_entity
    label: 'load second certificate'
    configuration:
      token_name: second_certificate
      from: current
      entity_type: node
      entity_id: '[current_certificates:0:nid]'
      revision_id: ''
      properties: ''
      langcode: _interface
      latest_revision: false
      unchanged: false
      object: ''
    successors:
      -
        id: Activity_0pcdiaw
        condition: ''
  Activity_0pcdiaw:
    plugin: 'eca_tamper:math'
    label: 'second_certificate + burned_certificate'
    configuration:
      operation: addition
      flip: false
      value: '[burned_certificate:field_limit_:value]'
      eca_data: '[second_certificate:field_limit_:value]'
      eca_token_name: start_balance
    successors:
      -
        id: Activity_0b2a3or
        condition: ''
  Activity_0b2a3or:
    plugin: 'eca_tamper:math'
    label: 'start_balance - actual_balance'
    configuration:
      operation: subtraction
      flip: false
      value: '[owner:field_balance_a_vacations_day:value]'
      eca_data: '[start_balance]'
      eca_token_name: number_used_days_per_year
    successors:
      -
        id: Gateway_0g6vu09
        condition: ''
  Activity_1718kix:
    plugin: action_message_action
    label: Activity_1718kix
    configuration:
      replace_tokens: false
      message: |-
        Не всі дні в сертифікаті використанні
        Залишок днів ->[number_used_days_per_year]
    successors:
      -
        id: Activity_082zxud
        condition: ''
  Activity_0eo0i23:
    plugin: action_message_action
    label: Activity_0eo0i23
    configuration:
      replace_tokens: false
      message: 'Всі дні в  згорівшому сертифікаті завершились'
    successors:
      -
        id: Activity_082zxud
        condition: ''
  Activity_082zxud:
    plugin: eca_list_remove
    label: 'Drop burned certificate'
    configuration:
      value: ''
      token_name: ''
      method: first
      index: ''
      list_token: burned_certificate
    successors:
      -
        id: Gateway_1vuijuo
        condition: ''
  Activity_1v0snzp:
    plugin: eca_switch_account
    label: switch
    configuration:
      user_id: '1'
    successors:
      -
        id: Activity_0fasaxx
        condition: ''
  Activity_0bvf3g0:
    plugin: eca_new_entity
    label: 'Create burning day transaction'
    configuration:
      token_name: burning_transaction
      type: 'node transaction'
      langcode: ''
      label: 'Burning a vacation days in "[certificate:title]"'
      published: true
      owner: '1'
    successors:
      -
        id: Activity_1n7dvo6
        condition: ''
  Activity_0fasaxx:
    plugin: eca_token_load_entity
    label: load
    configuration:
      token_name: certificate
      from: current
      entity_type: _none
      entity_id: ''
      revision_id: ''
      properties: ''
      langcode: _interface
      latest_revision: false
      unchanged: false
      object: ''
    successors:
      -
        id: Activity_0bvf3g0
        condition: Flow_0t4mg1p
  Activity_1n7dvo6:
    plugin: eca_set_field_value
    label: 'set field Status Transaction'
    configuration:
      field_name: field_status_transactions
      field_value: transaction_type_spent_when_burning_day
      method: 'set:clear'
      strip_tags: false
      trim: false
      save_entity: false
      object: '[burning_transaction]'
    successors:
      -
        id: Activity_00cja4o
        condition: ''
  Activity_00cja4o:
    plugin: eca_set_field_value
    label: 'set field owner'
    configuration:
      field_name: field_owner
      field_value: '[certificate:field_employee:entity]'
      method: 'set:clear'
      strip_tags: false
      trim: false
      save_entity: false
      object: '[burning_transaction]'
    successors:
      -
        id: Activity_0tvaivq
        condition: ''
  Activity_0tvaivq:
    plugin: eca_set_field_value
    label: 'set field Certificate'
    configuration:
      field_name: field_certificate
      field_value: '[certificate]'
      method: 'set:clear'
      strip_tags: false
      trim: false
      save_entity: false
      object: '[burning_transaction]'
    successors:
      -
        id: Activity_0f6rpaz
        condition: ''
  Activity_0f6rpaz:
    plugin: eca_trigger_content_entity_custom_event
    label: trigger
    configuration:
      event_id: x2
      tokens: ''
      object: '[burning_transaction]'
    successors: {  }
